<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAMA V.2 - Sale Assistant</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', 'Noto Sans Thai', sans-serif;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            overflow-x: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        #root {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
            --dark-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        
        .animate-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        
        .custom-scrollbar:hover::-webkit-scrollbar-thumb {
            background: #94a3b8;
        }
        
        .slide-in-from-bottom {
            animation: slideInFromBottom 0.5s ease-out;
        }
        
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        input, textarea, select {
            font-size: 16px !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }
        
        .fixed-height {
            height: 100vh;
            height: 100dvh;
        }
        
        /* Icon colors - flat colors */
        .icon-primary { color: #f59e0b; }
        .icon-secondary { color: #ea580c; }
        .icon-success { color: #10b981; }
        .icon-warning { color: #f59e0b; }
        .icon-danger { color: #ef4444; }
        .icon-purple { color: #8b5cf6; }
        .icon-pink { color: #ec4899; }
        .icon-gray { color: #6b7280; }
        
        /* Orange theme badges */
        .orange-badge {
            background: linear-gradient(45deg, #f59e0b, #ea580c);
            color: white;
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root" class="fixed-height"></div>
    
    <script>
        // ตั้งค่า Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans Thai', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#f59e0b',
                        'secondary': '#ea580c',
                    }
                }
            }
        };

        // --- Enhanced Regional Data Schema ---
        const RH_DATA = {
            "RH1": {
                name: "RH1: กรุงเทพฯ & ปริมณฑล",
                dynamics: "สังคมเมือง เร่งรีบ แข่งขันสูง ค่าครองชีพสูงที่สุด",
                keywords: ["ภาษีสังคม", "ค่าเสียเวลา", "ความคุ้มครองระดับพรีเมียม", "มรดกที่จับต้องได้"],
                hospitals: ["บำรุงราษฎร์", "สมิติเวช สุขุมวิท", "กรุงเทพ", "พญาไท 2"],
                tone: "Professional, กระชับ, เน้นตัวเลขและผลตอบแทน",
                context: "เน้นการบริหารภาษี และการรักษาที่รวดเร็วใน รพ. ระดับ World Class",
                commonGrounds: ["รถไฟฟ้า BTS/MRT", "ศูนย์การค้าชั้นนำ", "การจราจรติดขัด", "ค่าครองชีพสูง"],
                metaphors: ["เหมือนขาดทุนจากหุ้นลงทุน", "เทียบกับค่าเช่าคอนโด 1 เดือน", "เทียบกับภาษีรถยนต์หรู"]
            },
            "RH2": {
                name: "RH2: ภาคตะวันออก (EEC)",
                dynamics: "เขตเศรษฐกิจใหม่ นิคมอุตสาหกรรม เมืองท่องเที่ยว รายได้สูงแต่มีความเสี่ยง",
                keywords: ["ความเสี่ยงจากการทำงาน", "เงินก้อนหลังเกษียณไว", "สวัสดิการโรงงาน", "สวัสดิการเสริม"],
                hospitals: ["กรุงเทพพัทยา", "สมิติเวช ศรีราชา", "พญาไท ศรีราชา"],
                tone: "จริงใจ, เน้นความคุ้มค่า, ตรงไปตรงมา",
                context: "เน้นการสร้างรายได้เสริมจากสวัสดิการเดิมที่ไม่ครอบคลุมหลังออกจากงาน",
                commonGrounds: ["นิคมอุตสาหกรรม", "ท่าเรือแหลมฉบัง", "โรงงานขนาดใหญ่", "การท่องเที่ยวพัทยา"],
                metaphors: ["เทียบกับค่ารักษาอุบัติเหตุโรงงาน", "เหมือนเบี้ยประกันรถบรรทุก", "เทียบกับค่าสวัสดิการขาดไป"]
            },
            "RH3": {
                name: "RH3: ภาคเหนือ",
                dynamics: "สังคมผู้สูงอายุ วัฒนธรรมล้านนา ท่องเที่ยวเชิงวัฒนธรรม",
                keywords: ["บารมี", "ส่งต่อให้ลูกหลาน", "อยู่อย่างสง่างาม", "ความมั่นคงปลอดภัย"],
                hospitals: ["เชียงใหม่ ราม", "กรุงเทพเชียงใหม่", "ศรีพัฒน์"],
                tone: "นุ่มนวล, ให้เกียรติ, เน้นความสัมพันธ์ระยะยาว",
                context: "เน้นเรื่องมรดกและการดูแลสุขภาพในวัยเกษียณที่เป็นภาระลูกหลานให้น้อยที่สุด",
                commonGrounds: ["ประเพณีล้านนา", "การท่องเที่ยวเชิงวัฒนธรรม", "อากาศเย็นสบาย", "ชุมชนเข้มแข็ง"],
                metaphors: ["เหมือนมรดกจากปู่ย่าตายาย", "เทียบกับค่ารักษาโรคร้ายในโรงพยาบาลเอกชน", "เหมือนเงินก้อนให้ลูกแต่งงาน"]
            },
            "RH4": {
                name: "RH4: ภาคตะวันออกเฉียงเหนือ",
                dynamics: "ครอบครัวขยาย เกษตรกรรมก้าวหน้า เสาหลักคนสำคัญ",
                keywords: ["ความกตัญญู", "พึ่งพาตัวเองได้", "ทุนการศึกษาลูก", "ไม่เป็นภาระใคร"],
                hospitals: ["กรุงเทพขอนแก่น", "เอกอุดร", "พริ้นซ์ อุบลราชธานี"],
                tone: "เป็นกันเอง, จริงใจเหมือนญาติ, เข้าถึงง่าย",
                context: "เน้นการปกป้องเสาหลักของบ้านที่มีความรับผิดชอบต่อคนจำนวนมาก",
                commonGrounds: ["เกษตรกรรม", "ตลาดนัดชุมชน", "ครอบครัวใหญ่", "ความเป็นอยู่เรียบง่าย"],
                metaphors: ["เหมือนเงินกองทุนหมู่บ้าน", "เทียบกับค่ารักษา 1 ครั้งในกรุงเทพ", "เหมือนเงินส่งลูกเรียนมหาวิทยาลัย"]
            },
            "RH5": {
                name: "RH5: ภาคใต้",
                dynamics: "การประมง/สวนยาง/ท่องเที่ยว รายได้สูงเป็นช่วงเวลา",
                keywords: ["ใจนักเลง", "พวกพ้อง", "สภาพคล่อง", "การันตีรายได้"],
                hospitals: ["กรุงเทพหาดใหญ่", "กรุงเทพภูเก็ต", "สงขลานครินทร์ (SMC)"],
                tone: "หนักแน่น, ชัดเจน, จริงใจ, ไม่เยิ่นเย้อ",
                context: "เน้นการล็อกกำไรจากธุรกิจและการสร้างกระแสเงินสดที่สม่ำเสมอ",
                commonGrounds: ["สวนยางพารา", "การประมง", "ธุรกิจท่องเที่ยว", "เส้นทางชายฝั่ง"],
                metaphors: ["เหมือนประกันเรือประมง", "เทียบกับค่าน้ำยาง 1 วัน", "เหมือนเงินสำรองเมื่อพายุเข้ามา"]
            }
        };

        const ZONES = {
            "RH1": ["สาทร-สีลม", "สุขุมวิท", "ลาดพร้าว", "นนทบุรี", "สมุทรปราการ"],
            "RH2": ["ชลบุรี", "ศรีราชา-พัทยา", "ระยอง", "ฉะเชิงเทรา"],
            "RH3": ["เชียงใหม่", "เชียงราย", "พิษณุโลก", "นครสวรรค์"],
            "RH4": ["ขอนแก่น", "นครราชสีมา", "อุบลราชธานี", "อุดรธานี"],
            "RH5": ["หาดใหญ่", "ภูเก็ต", "สุราษฎร์ธานี", "นครศรีธรรมราช"]
        };

        // Insurance Products Database
        const INSURANCE_PRODUCTS = {
            "ลดหย่อนภาษี": [
                { name: "ประกันชีวิตแบบออมทรัพย์", coverage: "ชีวิต 1,000,000 บาท + สะสมทรัพย์", premium: "25,000-50,000", features: ["ลดหย่อนภาษีได้ 100%", "เงินคืนเมื่อครบสัญญา", "คุ้มครองชีวิต"] },
                { name: "ประกันชีวิตแบบบำนาญ", coverage: "ชีวิต + บำนาญวัยเกษียณ", premium: "30,000-60,000", features: ["ลดหย่อนภาษีได้ 100%", "รับเงินบำนาญเมื่อเกษียณ", "คุ้มครองชีวิตตลอดสัญญา"] }
            ],
            "มรดกให้ลูกหลาน": [
                { name: "ประกันชีวิตแบบตลอดชีพ", coverage: "ชีวิต 2,000,000 บาท", premium: "40,000-80,000", features: ["คุ้มครองตลอดชีวิต", "มรดกให้ทายาท", "เบี้ยประกันคงที่"] },
                { name: "ประกันชีวิตแบบสะสมทรัพย์", coverage: "ชีวิต 1,500,000 บาท + สะสมทรัพย์", premium: "30,000-50,000", features: ["มรดกพร้อมเงินออม", "เบี้ยประกันคงที่", "เงินคืนบางส่วนหากยังมีชีวิตอยู่"] }
            ],
            "ค่ารักษาพยาบาล (สุขภาพ)": [
                { name: "ประกันสุขภาพ IPD/OPD", coverage: "ค่ารักษาพยาบาลสูงสุด 500,000 บาท", premium: "15,000-30,000", features: ["คุ้มครองผู้ป่วยใน-ผู้ป่วยนอก", "เหมาจ่ายตามจริง", "ไม่มีวงเงินต่อครั้ง"] },
                { name: "ประกันโรคร้ายแรง", coverage: "โรคร้ายแรง 1,000,000 บาท", premium: "20,000-40,000", features: ["คุ้มครองโรคร้ายแรง 30 โรค", "จ่ายก้อนเมื่อตรวจพบโรค", "เบี้ยประกันคงที่"] }
            ],
            "เงินออม/เกษียณ": [
                { name: "ประกันชีวิตแบบสะสมทรัพย์ระยะยาว", coverage: "ชีวิต + สะสมทรัพย์", premium: "50,000-100,000", features: ["ออมเงินระยะยาว", "รับเงินก้อนเมื่อครบสัญญา", "ลดหย่อนภาษีได้"] },
                { name: "ประกันบำนาญก่อนเกษียณ", coverage: "ชีวิต + บำนาญ", premium: "60,000-120,000", features: ["รับบำนาญเมื่ออายุ 55/60 ปี", "คุ้มครองชีวิตระหว่างออม", "ลดหย่อนภาษีได้"] }
            ]
        };

        // Objection Handling Rules
        const OBJECTION_RULES = {
            "เงินไม่พอ": {
                technique: "LSCPA (Listen-Share-Clarify-Proceed-Ask)",
                responses: [
                    "ผม/ดิฉันเข้าใจดีว่าค่าใช้จ่ายทุกวันนี้สูงมาก",
                    "ลูกค้าหลายท่านกังวลเหมือนกัน แต่พบว่าการจ่ายเบี้ยประกันน้อยกว่าค่าใช้จ่ายที่ไม่คาดคิดในอนาคต",
                    "เรามาดูแผนที่เริ่มจากงบประมาณน้อยๆ ก่อนได้ไหม?"
                ],
                comparison: "เปรียบเทียบเบี้ยประกันกับค่าใช้จ่ายที่ไม่จำเป็น เช่น ค่าสูบบุหรี่/ซื้อลอตเตอรี่"
            },
            "มีประกันเยอะแล้ว": {
                technique: "Gap Analysis",
                responses: [
                    "ดีมากครับ/ค่ะ ที่คุณมีพื้นฐานการวางแผนแล้ว",
                    "เรามาตรวจสอบร่วมกันว่าแผนปัจจุบันครอบคลุมความเสี่ยงหลักหรือยัง",
                    "การประกันชีวิตไม่ใช่เรื่องของปริมาณ แต่เป็นเรื่องความพอเหมาะกับไลฟ์สไตล์ปัจจุบัน"
                ],
                comparison: "เปรียบเทียบกับสวัสดิการที่มีอยู่แล้ว ชี้จุดที่ยังขาด"
            },
            "ขอถามแฟน/ครอบครัวก่อน": {
                technique: "Value Proposition",
                responses: [
                    "เป็นการตัดสินใจที่ดีที่ปรึกษาครอบครัว",
                    "ผม/ดิฉันมีเอกสารสรุปให้คุณนำไปปรึกษาครอบครัวได้",
                    "ความรักและความห่วงใยคือสิ่งที่เราอยากปกป้องที่สุด"
                ],
                comparison: "เน้นการคุ้มครองคนที่รักแทนที่จะรอให้สายเกินไป"
            },
            "ประกันโกง/เบิกยาก": {
                technique: "Testimonial & Trust Building",
                responses: [
                    "ผม/ดิฉันเข้าใจความกังวลนี้ดี มีข่าวแบบนี้บ่อย",
                    "บริษัทของเรามีการจ่ายเคลม 98% ภายใน 7 วันทำการ",
                    "ผม/ดิฉันสามารถให้ข้อมูลลูกค้าที่เคยใช้บริการจริงได้"
                ],
                comparison: "เปรียบเทียบกับบริษัทที่จ่ายเคลมช้าหรือมีปัญหา"
            },
            "ยังไม่รีบ/ยังแข็งแรง": {
                technique: "Risk Awareness",
                responses: [
                    "ดีมากครับ/ค่ะ ที่คุณยังสุขภาพแข็งแรง",
                    "ประกันสุขภาพจะรับซื้อได้ง่ายและราคาถูกเมื่อยังสุขภาพดี",
                    "อุบัติเหตุหรือเจ็บป่วยไม่ได้บอกล่วงหน้า"
                ],
                comparison: "เปรียบเทียบกับการซื้อประกันรถก่อนขับรถ"
            }
        };

        // Prompt Library Database
        const PROMPT_LIBRARY = {
            "customer_analysis": [
                {
                    id: "CA1",
                    title: "วิเคราะห์ความต้องการลูกค้าใหม่",
                    prompt: "วิเคราะห์ความต้องการทางการเงินของลูกค้า อาชีพ [อาชีพ] อายุ [อายุ] รายได้ [รายได้] ต่อปี มีลูก [จำนวนลูก] คน หนี้สิน [หนี้สิน] บาท แนะนำแผนประกันที่เหมาะสม",
                    category: "วิเคราะห์ลูกค้า",
                    tags: ["ใหม่", "วิเคราะห์", "แนะนำแผน"]
                },
                {
                    id: "CA2",
                    title: "วิเคราะห์ความคุ้มครองที่มีอยู่",
                    prompt: "ลูกค้ามีประกันสุขภาพจากบริษัทแล้ว แต่ต้องการเพิ่มเติมเพื่อครอบคลุมโรคร้ายแรงและค่ารักษาพยาบาลส่วนเกิน แนะนำแผนเสริม",
                    category: "วิเคราะห์ลูกค้า",
                    tags: ["เสริม", "สุขภาพ", "โรคร้ายแรง"]
                }
            ],
            "product_comparison": [
                {
                    id: "PC1",
                    title: "เปรียบเทียบแผนประกันชีวิต",
                    prompt: "เปรียบเทียบแผนประกันชีวิตแบบสะสมทรัพย์กับแบบตลอดชีพ ข้อดีข้อเสียของแต่ละแผน สำหรับลูกค้าวัย [อายุ] ที่ต้องการ [เป้าหมาย]",
                    category: "เปรียบเทียบผลิตภัณฑ์",
                    tags: ["เปรียบเทียบ", "ชีวิต", "เลือกแผน"]
                },
                {
                    id: "PC2",
                    title: "เปรียบเทียบประกันสุขภาพ",
                    prompt: "เปรียบเทียบแผนประกันสุขภาพ IPD/OPD กับแผนโรคร้ายแรง เน้นความคุ้มครองและเบี้ยประกันสำหรับครอบครัวที่มีลูกเล็ก",
                    category: "เปรียบเทียบผลิตภัณฑ์",
                    tags: ["สุขภาพ", "ครอบครัว", "เปรียบเทียบ"]
                }
            ],
            "sales_script": [
                {
                    id: "SS1",
                    title: "สคริปต์เปิดบทสนทนา",
                    prompt: "สร้างบทสนทนาเปิดใจสำหรับลูกค้าอายุ [อายุ] อาชีพ [อาชีพ] ที่พบกันครั้งแรก เน้นการสร้างความสัมพันธ์และเข้าใจความต้องการ",
                    category: "สคริปต์ขาย",
                    tags: ["เปิดใจ", "บทสนทนา", "สร้างสัมพันธ์"]
                },
                {
                    id: "SS2",
                    title: "สคริปต์อธิบายผลประโยชน์",
                    prompt: "อธิบายผลประโยชน์ของแผนประกัน [ชื่อแผน] ด้วยภาษาง่ายๆ เปรียบเทียบกับค่าครองชีพประจำวัน เพื่อให้ลูกค้าเห็นภาพความคุ้มค่า",
                    category: "สคริปต์ขาย",
                    tags: ["อธิบาย", "ผลประโยชน์", "เข้าใจง่าย"]
                },
                {
                    id: "SS3",
                    title: "สคริปต์ปิดการขาย",
                    prompt: "ปิดการขายแผนประกัน [ชื่อแผน] โดยสรุปจุดเด่นที่ลูกค้าชอบและแก้ไขข้อกังวล [ข้อกังวล] พร้อมสร้างความเร่งด่วน",
                    category: "สคริปต์ขาย",
                    tags: ["ปิดการขาย", "สรุป", "แก้ข้อกังวล"]
                }
            ],
            "objection_handling": [
                {
                    id: "OH1",
                    title: "ตอบข้อโต้แย้ง 'เงินไม่พอ'",
                    prompt: "ลูกค้าบอกว่า 'เงินไม่พอ' จะซื้อประกัน ตอบอย่างไรให้ลูกค้าเห็นความสำคัญและเริ่มต้นด้วยแผนที่เหมาะสมกับงบประมาณ",
                    category: "ตอบข้อโต้แย้ง",
                    tags: ["เงินไม่พอ", "งบประมาณ", "เริ่มต้น"]
                },
                {
                    id: "OH2",
                    title: "ตอบข้อโต้แย้ง 'มีประกันเยอะแล้ว'",
                    prompt: "ลูกค้าบอกว่า 'มีประกันเยอะแล้ว' จะชวนลูกค้าตรวจสอบความคุ้มครองที่มีและชี้ให้เห็นจุดที่ยังขาดอย่างไร",
                    category: "ตอบข้อโต้แย้ง",
                    tags: ["มีแล้ว", "ตรวจสอบ", "เติมเต็ม"]
                }
            ]
        };

        // Conversation Scripts Database
        const CONVERSATION_SCRIPTS = {
            "ice_breaking": [
                {
                    id: "IB1",
                    title: "เปิดบทสนทนากับลูกค้าใหม่",
                    script: "สวัสดีครับ/ค่ะ ดิฉัน/ผม [ชื่อตัวแทน] จากบริษัทประกันชีวิต ดิฉัน/ผมเห็นว่าคุณสนใจเรื่องการวางแผนการเงิน วันนี้มีโอกาสดีมาพูดคุยแลกเปลี่ยนกันค่ะ",
                    tips: ["ยิ้มแย้มแจ่มใส", "เริ่มจากคำถามทั่วไปก่อน", "สร้างบรรยากาศเป็นกันเอง"],
                    follow_up: "คุณพอมีเวลาสัก 10 นาทีไหมครับ/คะ เพื่อที่ดิฉัน/ผมจะได้แนะนำตัวและเข้าใจความต้องการของคุณมากขึ้น"
                },
                {
                    id: "IB2",
                    title: "เชื่อมโยงกับอาชีพลูกค้า",
                    script: "ในฐานะที่คุณเป็น [อาชีพ] ดิฉัน/ผมเข้าใจดีว่าความเสี่ยงในอาชีพนี้มีอะไรบ้าง และการวางแผนการเงินมีความสำคัญอย่างไรสำหรับคุณ",
                    tips: ["แสดงความเข้าใจในอาชีพ", "ยกตัวอย่างกรณีศึกษา", "เชื่อมโยงกับชีวิตจริง"],
                    follow_up: "เคยมีลูกค้าที่เป็น [อาชีพ] เช่นกันเลือกแผนนี้เพราะตอบโจทย์ไลฟ์สไตล์การทำงาน คุณอยากทราบรายละเอียดไหมครับ/คะ?"
                }
            ],
            "objection_scenarios": [
                {
                    id: "OS1",
                    title: "สถานการณ์: ลูกค้าบอก 'เงินไม่พอ'",
                    script: "ลูกค้า: 'ช่วงนี้ค่าใช้จ่ายเยอะ ไม่มีเงินพอจะซื้อประกัน'\n\nตัวแทน: 'ผม/ดิฉันเข้าใจดีครับ/ค่ะว่าตอนนี้ค่าครองชีพสูงมาก ลูกค้าหลายท่านก็มีความกังวลแบบเดียวกัน แต่หลังจากได้คุยกันพบว่า...'",
                    technique: "LSCPA (ฟัง-แบ่งปัน-ชี้แจง-ดำเนินการ-ถาม)",
                    key_points: ["แสดงความเข้าใจ", "ยกตัวอย่างลูกค้าที่มีสถานการณ์คล้ายกัน", "เสนอแผนเริ่มต้นเล็กๆ"]
                },
                {
                    id: "OS2",
                    title: "สถานการณ์: ลูกค้าบอก 'ขอปรึกษาครอบครัวก่อน'",
                    script: "ลูกค้า: 'เดี๋ยวต้องกลับไปปรึกษาครอบครัวก่อนครับ/คะ'\n\nตัวแทน: 'เป็นการตัดสินใจที่ดีมากครับ/คะที่ปรึกษาครอบครัว เพราะแผนการเงินที่ดีควรได้รับการสนับสนุนจากคนในครอบครัว...'",
                    technique: "Value Proposition (เน้นคุณค่า)",
                    key_points: ["ชื่นชมการตัดสินใจ", "เสนอเอกสารสรุปให้นำไปปรึกษา", "นัดหมายติดตามผล"]
                }
            ]
        };

        // Icon mapping - Flat color icons (Orange theme)
        const ICONS = {
            calculator: '<i class="fas fa-calculator icon-primary"></i>',
            message: '<i class="fas fa-comment-dots icon-secondary"></i>',
            shield: '<i class="fas fa-shield-alt icon-warning"></i>',
            gift: '<i class="fas fa-gift icon-success"></i>',
            bag: '<i class="fas fa-shopping-bag icon-purple"></i>',
            file: '<i class="fas fa-file-check icon-success"></i>',
            terminal: '<i class="fas fa-terminal icon-gray"></i>',
            sparkles: '<i class="fas fa-sparkles icon-warning"></i>',
            map: '<i class="fas fa-map-marker-alt icon-danger"></i>',
            alert: '<i class="fas fa-exclamation-circle icon-danger"></i>',
            building: '<i class="fas fa-building icon-primary"></i>',
            stethoscope: '<i class="fas fa-stethoscope icon-purple"></i>',
            lightbulb: '<i class="fas fa-lightbulb icon-warning"></i>',
            zap: '<i class="fas fa-bolt icon-warning"></i>',
            trending: '<i class="fas fa-chart-line icon-success"></i>',
            copy: '<i class="fas fa-copy icon-gray"></i>',
            rotate: '<i class="fas fa-redo icon-gray"></i>',
            thumbsUp: '<i class="fas fa-thumbs-up icon-success"></i>',
            thumbsDown: '<i class="fas fa-thumbs-down icon-danger"></i>',
            share: '<i class="fas fa-share-alt icon-primary"></i>',
            save: '<i class="fas fa-save icon-primary"></i>',
            chevronRight: '<i class="fas fa-chevron-right"></i>',
            library: '<i class="fas fa-book icon-primary"></i>',
            script: '<i class="fas fa-scroll icon-warning"></i>',
            users: '<i class="fas fa-users icon-secondary"></i>',
            heart: '<i class="fas fa-heart icon-danger"></i>',
            clipboard: '<i class="fas fa-clipboard-list icon-success"></i>',
            search: '<i class="fas fa-search icon-primary"></i>',
            filter: '<i class="fas fa-filter icon-secondary"></i>',
            download: '<i class="fas fa-download icon-primary"></i>'
        };

        // --- Rule-based Analysis Engine ---
        class RuleBasedEngine {
            static analyzeNeeds(formData, rhData, zone) {
                const income = parseFloat(formData.income) || 0;
                const expense = parseFloat(formData.expense) || 0;
                const debt = parseFloat(formData.debt) || 0;
                const dependents = parseInt(formData.dependents) || 0;
                const years = parseInt(formData.years) || 1;
                const assets = parseFloat(formData.assets) || 0;
                
                const totalNeed = debt + (expense * 12 * years);
                const gap = Math.max(0, totalNeed - assets);
                const months = expense > 0 ? (assets / expense) : 0;
                
                // Risk assessment based on rules
                let riskLevel = "ต่ำ";
                let recommendations = [];
                
                if (gap > income * 5) riskLevel = "สูงมาก";
                else if (gap > income * 3) riskLevel = "สูง";
                else if (gap > income * 1) riskLevel = "ปานกลาง";
                
                // Rule-based recommendations
                if (gap > 0) {
                    const recommendedCoverage = Math.round(gap / 1000000);
                    recommendations.push(`ควรมีทุนประกันชีวิตอย่างน้อย ${recommendedCoverage} ล้านบาท`);
                }
                
                if (expense > income * 0.4) {
                    recommendations.push("พิจารณาปรับลดค่าใช้จ่ายที่ไม่จำเป็น หรือหารายได้เสริม");
                }
                
                if (dependents > 0) {
                    recommendations.push(`ควรวางแผนการศึกษาสำหรับลูก ${dependents >= 2 ? 'แต่ละคน' : ''}`);
                }
                
                if (years < 10) {
                    recommendations.push("ควรวางแผนการออมระยะยาวเพิ่มเติมสำหรับวัยเกษียณ");
                }
                
                // Check existing insurance
                if (formData.insurance_existing && formData.insurance_existing.trim() !== "") {
                    recommendations.push("ตรวจสอบความคุ้มครองที่มีอยู่แล้วว่าครอบคลุมความเสี่ยงหลักหรือไม่");
                }
                
                // Check insurance gap
                if (formData.insurance_gap && formData.insurance_gap.trim() !== "") {
                    recommendations.push(`เน้นเติมเต็มในส่วนที่ลูกค้ารู้สึกว่าคุ้มครองไม่พอ: ${formData.insurance_gap}`);
                }
                
                const metaphor = rhData.metaphors ? rhData.metaphors[Math.floor(Math.random() * rhData.metaphors.length)] : "เทียบกับค่าครองชีพในพื้นที่";
                
                return {
                    gap,
                    months: months.toFixed(1),
                    riskLevel,
                    recommendations,
                    metaphor,
                    actionPlan: `1. เริ่มต้นด้วยทุนประกัน ${Math.max(1000000, Math.round(gap * 0.3)).toLocaleString()} บาท\n2. เติมเต็มประกันสุขภาพครอบคลุมโรคร้ายแรง\n3. วางแผนการออมระยะยาว`
                };
            }
            
            static generateIceBreaking(formData, rhData, zone) {
                const age = formData.age || "35-40";
                const job = formData.job || "อาชีพทั่วไป";
                const location = formData.location || "สถานที่พบกัน";
                const observation = formData.observation || "";
                const relationshipLevel = formData.relationship_level || "ใหม่";
                const commonInterest = formData.common_interest || "";
                
                const commonGround = rhData.commonGrounds ? rhData.commonGrounds[Math.floor(Math.random() * rhData.commonGrounds.length)] : "วัฒนธรรมท้องถิ่น";
                
                // Rule-based conversation starters
                const starters = [];
                
                if (relationshipLevel === "ใหม่") {
                    starters.push(`"สวัสดีครับ/ค่ะ ดิฉัน/ผมเป็นที่ปรึกษาการเงินจาก MAMA วันนี้มีโอกาสดีมาแนะนำตัวและทำความรู้จักกัน"`);
                } else if (relationshipLevel === "พอคุ้นเคย") {
                    starters.push(`"สวัสดีครับ/ค่ะ ดีใจที่ได้พบกันอีกครั้ง คราวก่อนคุยกันเรื่อง ${commonInterest || 'การวางแผนการเงิน'} ผม/ดิฉันมีข้อมูลเพิ่มเติมมาแบ่งปันค่ะ"`);
                } else {
                    starters.push(`"สวัสดีครับ/ค่ะ กลับมาพบกันอีกแล้วนะครับ/คะ วันนี้มีแผนใหม่ๆ มาแนะนำโดยเฉพาะสำหรับคุณ"`);
                }
                
                const jobConnection = [
                    `"สำหรับ${job}แบบคุณ มักมีความเสี่ยงเรื่องรายได้ไม่สม่ำเสมอ/อุบัติเหตุจากการทำงาน เรามีแผนที่จัดการได้"`,
                    `"ลูกค้าที่เป็น${job}หลายท่านเลือกแผนนี้เพราะตอบโจทย์ไลฟ์สไตล์ทำงาน"`,
                    `"อาชีพ${job}มีข้อดีหลายอย่าง แต่ในแง่การเงินอาจมีจุดที่ต้องเสริม เช่น การคุ้มครองรายได้ระหว่างพักฟื้น"`
                ];
                
                const hook = [
                    `"ถ้ามีวันหนึ่งคุณไม่สามารถทำงานได้อีก ${dependents > 0 ? 'ลูก' : 'ครอบครัว'}คุณจะมีเงินใช้กี่เดือน?"`,
                    `"เคยคำนวณไหมว่า ถ้าวันนี้คุณหายไปจากครอบครัว รายได้ที่ขาดหายจะเท่าไร?"`,
                    `"สุขภาพที่ดีวันนี้ ไม่รับประกันว่าจะดีไปตลอด เราวางแผนกันยังไงดี?"`
                ];
                
                // Observation-based approach
                let observationApproach = "";
                if (observation.includes("สมาร์ทวอทช์") || observation.includes("นาฬิกา")) {
                    observationApproach = "เห็นคุณใส่สมาร์ทวอทช์ นั่นแสดงว่าคุณใส่ใจสุขภาพดีนะครับ/คะ การวางแผนการเงินก็เหมือนการติดตามสุขภาพทางการเงิน";
                } else if (observation.includes("หนังสือลงทุน") || observation.includes("หุ้น")) {
                    observationApproach = "เห็นคุณสนใจการลงทุน เป็นสิ่งที่ดีมากครับ/คะ การประกันชีวิตก็เป็นการลงทุนในความมั่นคงของครอบครัว";
                } else if (observation.includes("รีบ")) {
                    observationApproach = "เห็นคุณดูรีบๆ นะครับ/คะ แต่อยากให้มีเวลาสัก 10 นาทีคุยกันเรื่องที่สำคัญกับอนาคตการเงินของคุณ";
                }
                
                return {
                    starters,
                    jobConnection,
                    hook,
                    observationApproach,
                    tone: rhData.tone || "เป็นมืออาชีพ",
                    commonGround,
                    tips: [
                        "เริ่มจากประเด็นทั่วไปก่อนเข้าสู่ธุรกิจ",
                        "ถามถึงความกังวลทางการเงิน",
                        "เสนอตัวอย่างกรณีศึกษาที่ใกล้เคียง"
                    ]
                };
            }
            
            static handleObjection(formData, rhData, zone) {
                const type = formData.type || "เงินไม่พอ";
                const quote = formData.direct_quote || "";
                const customerTone = formData.customer_tone || "กังวล";
                const previousAttempts = formData.previous_attempts || "";
                
                const rule = OBJECTION_RULES[type] || OBJECTION_RULES["เงินไม่พอ"];
                
                // Tone-based response adjustment
                let toneAdjustment = "";
                if (customerTone === "กังวล") {
                    toneAdjustment = "ใช้น้ำเสียงที่เข้าใจและเห็นใจ";
                } else if (customerTone === "ไม่มั่นใจ") {
                    toneAdjustment = "เพิ่มข้อมูลสนับสนุนและตัวอย่างกรณีศึกษา";
                } else if (customerTone === "ปฏิเสธ") {
                    toneAdjustment = "อย่าพยายามโน้มน้าว แต่ถามถึงเหตุผลเบื้องหลัง";
                } else if (customerTone === "เหนื่อย") {
                    toneAdjustment = "พูดสั้นๆ กระชับ และเสนอทางเลือกที่ง่าย";
                }
                
                // Check previous attempts
                let learnFromPrevious = "";
                if (previousAttempts) {
                    learnFromPrevious = `จากที่คุณเคยลอง ${previousAttempts} เรามาลองวิธีอื่นดูไหมครับ/คะ`;
                }
                
                // Generate response based on rules
                const response = {
                    technique: rule.technique,
                    steps: [
                        `ฟัง: "คุณบอกว่า: ${quote || '...'} ผม/ดิฉันเข้าใจดีครับ/คะ"`,
                        `แบ่งปัน: "ลูกค้าหลายท่านใน${zone}ก็มีความคิดแบบนี้ แต่หลังจากคุยกันพบว่า..."`,
                        `ชี้แจง: "${rule.responses[1]}"`,
                        `ดำเนินการ: "${rule.responses[2]}"`,
                        `ถาม: "คุณคิดว่ายังไงกับแนวทางนี้ครับ/คะ?"`
                    ],
                    reframing: `"แทนที่จะมองว่าเป็นค่าใช้จ่าย ลองมองว่าเป็น${rule.comparison}สิครับ/คะ"`,
                    toneAdjustment,
                    learnFromPrevious,
                    closing: `"ไม่ว่าคุณจะกังวลเรื่อง${type} เรามีทางเลือกให้คุณเสมอ"`
                };
                
                return response;
            }
            
            static simplifyPlan(formData, rhData, zone) {
                const planName = formData.plan_name || "แผนประกัน";
                const premium = parseFloat(formData.premium) || 10000;
                const benefits = formData.benefits || "";
                const competitorComparison = formData.competitor_comparison || "ไม่รู้จัก";
                const uniqueSellingPoint = formData.unique_selling_point || "";
                
                const dailyCost = (premium / 365).toFixed(2);
                const monthlyCost = (premium / 12).toFixed(2);
                
                // Local cost comparison based on zone
                let localComparison = "ค่ากาแฟ 1 แก้ว";
                if (zone.includes("กรุงเทพ") || zone.includes("สาทร") || zone.includes("สุขุมวิท")) {
                    localComparison = "ค่ากาแฟร้าน Starbucks 1 แก้ว";
                } else if (zone.includes("พัทยา") || zone.includes("ภูเก็ต")) {
                    localComparison = "ค่าเครื่องดื่ม 1 แก้วในร้านริมทะเล";
                } else if (zone.includes("เชียงใหม่")) {
                    localComparison = "ค่าข้าวซอย 1 ชาม";
                } else if (zone.includes("ขอนแก่น") || zone.includes("อุดร")) {
                    localComparison = "ค่าส้มตำปูปลาร้า 2 จาน";
                } else if (zone.includes("หาดใหญ่")) {
                    localComparison = "ค่าขนมจีน 1 ที่";
                }
                
                // Extract benefits
                const benefitList = benefits.split('\n').filter(b => b.trim()).slice(0, 5);
                const simplifiedBenefits = benefitList.length > 0 ? benefitList : [
                    "คุ้มครองชีวิตและสุขภาพครบวงจร",
                    "เบี้ยคงที่ตลอดสัญญา",
                    "เงินคืนเมื่อครบอายุสัญญา",
                    "คุ้มครองโรคร้ายแรง",
                    "บริการรถพยาบาลฟรี"
                ];
                
                // Competitor strategy
                let competitorStrategy = "";
                if (competitorComparison === "รู้จักชื่อคู่แข่ง") {
                    competitorStrategy = "เน้นจุดเด่นที่แตกต่างจากคู่แข่ง เช่น เงื่อนไขที่ง่ายกว่า หรือบริการหลังการขายที่ดีกว่า";
                } else if (competitorComparison === "เคยได้ยิน") {
                    competitorStrategy = "อธิบายความน่าเชื่อถือของบริษัทเราและเครือข่ายโรงพยาบาล";
                } else {
                    competitorStrategy = "สร้างความเข้าใจในผลิตภัณฑ์ก่อน แล้วค่อยเปรียบเทียบในภายหลัง";
                }
                
                // Generate golden sentences
                const goldenSentences = [
                    `"คุ้มครองชีวิตและสุขภาพรายวันในราคาเพียง ${dailyCost} บาท/วัน (เท่ากับ${localComparison})"`,
                    `"${simplifiedBenefits[0].replace(/[0-9\.]+/g, '').substring(0, 50)}"`,
                    `"วางแผนการเงินมั่นใจได้ เพราะ${planName}ดูแลคุณทั้งวันนี้และวันหน้า"`,
                    `"เบี้ยเริ่มต้นเพียง ${monthlyCost} บาท/เดือน คุ้มครองได้ทั้งครอบครัว"`
                ];
                
                // Add USP if provided
                if (uniqueSellingPoint) {
                    goldenSentences.push(`"${uniqueSellingPoint.substring(0, 80)}"`);
                }
                
                return {
                    dailyCost,
                    monthlyCost,
                    localComparison,
                    goldenSentences: goldenSentences.slice(0, 3),
                    benefitSummary: simplifiedBenefits,
                    competitorStrategy,
                    presentationTips: [
                        "เปรียบเทียบกับค่าครองชีพในพื้นที่",
                        "เน้นความคุ้มค่าต่อวันมากกว่าต่อปี",
                        "ยกตัวอย่างกรณีศึกษาจริงในพื้นที่",
                        "ใช้ภาษาง่ายๆ ไม่ใช้ศัพท์เทคนิคมากเกินไป"
                    ]
                };
            }
            
            static matchProduct(formData, rhData, zone) {
                const goal = formData.goal || "ลดหย่อนภาษี";
                const budget = parseFloat(formData.budget) || 30000;
                const existingCoverage = formData.existing_coverage || "";
                const priorityLevel = formData.priority_level || "ปานกลาง";
                
                const products = INSURANCE_PRODUCTS[goal] || INSURANCE_PRODUCTS["ลดหย่อนภาษี"];
                
                // Rule-based product matching
                let recommendedProduct = products[0];
                let reason = "";
                
                if (goal === "ลดหย่อนภาษี") {
                    recommendedProduct = products.find(p => p.name.includes("ออมทรัพย์")) || products[0];
                    reason = "เหมาะสำหรับการลดหย่อนภาษีสูงสุด 100% และมีเงินคืนเมื่อครบสัญญา";
                } else if (goal === "ค่ารักษาพยาบาล (สุขภาพ)") {
                    recommendedProduct = products.find(p => p.name.includes("IPD/OPD")) || products[0];
                    reason = "ครอบคลุมค่ารักษาพยาบาลทั้งผู้ป่วยในและผู้ป่วยนอก เหมาจ่ายตามจริง";
                } else if (goal === "มรดกให้ลูกหลาน") {
                    recommendedProduct = products.find(p => p.name.includes("ตลอดชีพ")) || products[0];
                    reason = "คุ้มครองตลอดชีวิต มรดกให้ทายาทโดยไม่ต้องเสียภาษี";
                } else if (goal === "เงินออม/เกษียณ") {
                    recommendedProduct = products.find(p => p.name.includes("บำนาญ")) || products[0];
                    reason = "รับเงินบำนาญเมื่อเกษียณ สร้างรายได้มั่นคงในวัยทอง";
                }
                
                // Budget check
                const priceRange = recommendedProduct.premium.split('-').map(p => parseInt(p.replace(/[^0-9]/g, '')));
                const minPrice = priceRange[0];
                const maxPrice = priceRange[1] || priceRange[0];
                
                let budgetFit = "พอดี";
                if (budget < minPrice) {
                    budgetFit = "ต่ำกว่าเกณฑ์ (อาจต้องปรับแผนหรือเลือกรุ่นเริ่มต้น)";
                } else if (budget > maxPrice * 1.5) {
                    budgetFit = "สูงกว่าเกณฑ์ (สามารถเพิ่มความคุ้มครองได้)";
                }
                
                // Analyze existing coverage
                const existingWelfare = ["ประกันสังคม"];
                if (existingCoverage.includes("บริษัท") || existingCoverage.includes("องค์กร")) {
                    existingWelfare.push("สวัสดิการบริษัท");
                }
                if (existingCoverage.includes("รถ") || existingCoverage.includes("ทรัพย์สิน")) {
                    existingWelfare.push("ประกันภัยรถ/ทรัพย์สิน");
                }
                
                // Identify missing coverage
                const missingCoverage = [];
                if (goal === "ค่ารักษาพยาบาล (สุขภาพ)" && !existingCoverage.includes("สุขภาพ")) {
                    missingCoverage.push("ค่ารักษาพยาบาลส่วนเกินจากประกันสังคม");
                }
                if (goal === "มรดกให้ลูกหลาน" && !existingCoverage.includes("ชีวิต")) {
                    missingCoverage.push("ทุนประกันชีวิตเพื่อมรดก");
                }
                if (goal === "เงินออม/เกษียณ" && !existingCoverage.includes("ออม")) {
                    missingCoverage.push("การออมระยะยาวเพื่อวัยเกษียณ");
                }
                
                // Priority-based action plan
                let actionPlan = "";
                if (priorityLevel === "สูง") {
                    actionPlan = `เริ่มต้นทันทีด้วยเบี้ย ${Math.max(10000, budget * 0.9).toLocaleString()} บาท/ปี เพื่อความคุ้มครองเบื้องต้น`;
                } else if (priorityLevel === "ปานกลาง") {
                    actionPlan = `เริ่มต้นภายในเดือนนี้ด้วยเบี้ย ${Math.max(8000, budget * 0.8).toLocaleString()} บาท/ปี`;
                } else {
                    actionPlan = `วางแผนล่วงหน้า เบี้ยประมาณ ${budget.toLocaleString()} บาท/ปี เริ่มต้นไตรมาสหน้า`;
                }
                
                return {
                    recommendedProduct,
                    budgetFit,
                    reason,
                    existingWelfare,
                    missingCoverage: missingCoverage.length > 0 ? missingCoverage : ["การคุ้มครองเฉพาะทางตามเป้าหมาย"],
                    actionPlan,
                    nextSteps: [
                        "ตรวจสอบคุณสมบัติเบื้องต้น",
                        "เตรียมเอกสารประกอบการสมัคร",
                        "นัดหมายเพื่อเริ่มกระบวนการ"
                    ]
                };
            }
            
            static generateClosing(formData, rhData, zone) {
                const interestPoint = formData.interest_point || "ความคุ้มครองสุขภาพ";
                const lastConcern = formData.last_concern || "ค่าเบี้ยประกัน";
                const timeline = formData.timeline || "ยังไม่แน่ใจ";
                const decisionMaker = formData.decision_maker || "ตัวเอง";
                
                // Urgency factor based on region and timeline
                let urgency = "";
                if (zone.includes("กรุงเทพ") || zone.includes("ปริมณฑล")) {
                    urgency = "สิทธิพิเศษโรงพยาบาลเอกชนชั้นนำในเครือข่าย";
                } else if (zone.includes("พัทยา") || zone.includes("ภูเก็ต")) {
                    urgency = "โปรโมชั่นพิเศษสำหรับลูกค้าพื้นที่ท่องเที่ยว";
                } else if (zone.includes("เชียงใหม่")) {
                    urgency = "สิทธิพิเศษโรงพยาบาลในเครือข่ายภาคเหนือ";
                } else {
                    urgency = "เครือข่ายโรงพยาบาลในพื้นที่";
                }
                
                // Timeline-based approach
                let timelineStrategy = "";
                if (timeline === "ภายในสัปดาห์นี้") {
                    timelineStrategy = "เราสามารถเริ่มกระบวนการได้ทันทีเพื่อไม่ให้พลาดสิทธิประโยชน์";
                } else if (timeline === "ภายในเดือนนี้") {
                    timelineStrategy = "ควรเริ่มต้นกระบวนการภายใน 1-2 สัปดาห์ เพื่อให้ทันภายในเดือนนี้";
                } else if (timeline === "วางแผนล่วงหน้า") {
                    timelineStrategy = "เป็นการวางแผนที่ดี การเริ่มต้นเร็วจะทำให้ได้รับความคุ้มครองเร็วขึ้น";
                } else {
                    timelineStrategy = "เรามาเริ่มต้นวางแผนกันตั้งแต่วันนี้ เพื่ออนาคตการเงินที่มั่นคง";
                }
                
                // Decision maker strategy
                let decisionMakerStrategy = "";
                if (decisionMaker === "คู่สมรส" || decisionMaker === "ผู้ปกครอง") {
                    decisionMakerStrategy = `ควรปรึกษากับ${decisionMaker}ร่วมกัน เพื่อการตัดสินใจที่ครอบคลุมทุกความต้องการ`;
                } else if (decisionMaker === "ตัวเอง") {
                    decisionMakerStrategy = "คุณสามารถตัดสินใจได้ทันทีเพื่อความคุ้มครองที่รวดเร็ว";
                } else {
                    decisionMakerStrategy = "ควรมีผู้มีส่วนร่วมในการตัดสินใจเพื่อความมั่นใจ";
                }
                
                // Alternative close techniques
                const closes = [
                    `"คุณสะดวกเริ่มแผนวันไหนดีครับ/คะ หรือจะเริ่มตั้งแต่วันนี้เลย?"`,
                    `"คุณอยากเน้น${interestPoint}เป็นหลัก หรือมีประเด็นอื่นที่กังวลนอกจาก${lastConcern}?"`,
                    `"เพื่อไม่ให้พลาด${urgency} เราเริ่มต้นเอกสารเบื้องต้นเลยดีไหม?"`,
                    `"ระหว่างแผน A ที่เน้น${interestPoint} กับแผน B ที่เน้นค่าเบี้ยต่ำ คุณชอบแนวทางไหนมากกว่าครับ/คะ?"`
                ];
                
                const summary = `"สรุปคือ คุณให้ความสำคัญกับ${interestPoint} แต่กังวลเรื่อง${lastConcern} ทางเรามีวิธีแก้โดย... และมี${urgency}ให้ด้วย"`;
                
                return {
                    urgency,
                    timelineStrategy,
                    decisionMakerStrategy,
                    closes,
                    summary,
                    nextStep: "กรอกใบสมัครเบื้องต้นเพื่อจองสิทธิ์",
                    confidenceBuilder: `"ลูกค้าใน${zone}กว่า 85% ที่เลือกแผนนี้พอใจในระยะยาว"`
                };
            }
            
            static getPromptLibrary(category = "all") {
                if (category === "all") {
                    return PROMPT_LIBRARY;
                }
                return PROMPT_LIBRARY[category] || [];
            }
            
            static getConversationScripts(type = "all") {
                if (type === "all") {
                    return CONVERSATION_SCRIPTS;
                }
                return CONVERSATION_SCRIPTS[type] || [];
            }
        }

        // --- React-like Components without React ---
        class MAMAV2NonAI {
            constructor() {
                this.state = {
                    isSetup: false,
                    userProfile: { rh: "", zone: "" },
                    activeTab: "needs_analysis",
                    activeSubTab: "input",
                    loading: false,
                    response: "",
                    error: "",
                    feedback: null,
                    forms: {
                        needs_analysis: { 
                            income: "", 
                            expense: "", 
                            debt: "", 
                            dependents: "", 
                            years: "", 
                            assets: "",
                            insurance_existing: "",
                            insurance_gap: ""
                        },
                        ice_breaking: { 
                            age: "", 
                            job: "", 
                            location: "", 
                            observation: "",
                            relationship_level: "",
                            common_interest: ""
                        },
                        objection: { 
                            type: "เงินไม่พอ", 
                            direct_quote: "",
                            customer_tone: "",
                            previous_attempts: ""
                        },
                        simplifier: { 
                            plan_name: "", 
                            benefits: "", 
                            premium: "",
                            competitor_comparison: "",
                            unique_selling_point: ""
                        },
                        matchmaker: { 
                            goal: "ลดหย่อนภาษี", 
                            budget: "",
                            existing_coverage: "",
                            priority_level: ""
                        },
                        closing: { 
                            interest_point: "", 
                            last_concern: "",
                            timeline: "",
                            decision_maker: ""
                        },
                        prompt_library: {
                            category: "customer_analysis",
                            custom_objective: "",
                            custom_target: "",
                            custom_details: ""
                        }
                    },
                    promptLibrary: {
                        selectedCategory: "customer_analysis",
                        selectedPrompt: null,
                        customPrompt: ""
                    }
                };
                
                this.inputElements = {};
                this.init();
            }
            
            setState(newState) {
                for (let key in newState) {
                    if (typeof this.state[key] === 'object' && this.state[key] !== null && !Array.isArray(this.state[key])) {
                        this.state[key] = { ...this.state[key], ...newState[key] };
                    } else {
                        this.state[key] = newState[key];
                    }
                }
                this.render();
            }
            
            handleInputChange(tab, field, value) {
                this.state.forms[tab][field] = value;
                const inputId = `${tab}-${field}`;
                if (this.inputElements[inputId]) {
                    this.inputElements[inputId].value = value;
                }
                if (tab === 'needs_analysis') {
                    this.updateGapDisplay();
                }
            }
            
            handlePromptLibrarySelect(category, promptId = null) {
                this.setState({
                    promptLibrary: {
                        ...this.state.promptLibrary,
                        selectedCategory: category,
                        selectedPrompt: promptId
                    }
                });
            }
            
            calculateRealityCheck() {
                const f = this.state.forms.needs_analysis;
                const income = parseFloat(f.income) || 0;
                const expense = parseFloat(f.expense) || 0;
                const debt = parseFloat(f.debt) || 0;
                const years = parseFloat(f.years) || 1;
                const assets = parseFloat(f.assets) || 0;
                
                const totalNeed = debt + (expense * 12 * years);
                const gap = Math.max(0, totalNeed - assets);
                const months = expense > 0 ? (assets / expense) : 0;
                return { gap, months };
            }
            
            updateGapDisplay() {
                const { gap } = this.calculateRealityCheck();
                const gapElement = document.getElementById('protection-gap');
                if (gapElement) {
                    gapElement.textContent = `${gap.toLocaleString()} บาท`;
                }
            }
            
            generateResponse() {
                this.setState({ loading: true, response: "", error: "" });
                
                setTimeout(() => {
                    try {
                        const tab = this.state.activeTab;
                        const formData = this.state.forms[tab];
                        const rhData = RH_DATA[this.state.userProfile.rh] || {};
                        const zone = this.state.userProfile.zone;
                        
                        let result;
                        let responseHTML = "";
                        
                        switch(tab) {
                            case "needs_analysis":
                                result = RuleBasedEngine.analyzeNeeds(formData, rhData, zone);
                                responseHTML = `### 🎯 ผลการวิเคราะห์ Protection Gap
                                
**ข้อมูลการวิเคราะห์:**
- Protection Gap: ${result.gap.toLocaleString()} บาท
- ระยะเวลาอยู่รอด: ${result.months} เดือน
- ระดับความเสี่ยง: ${result.riskLevel}

**การเปรียบเทียบในพื้นที่${zone}:**
ทุนประกันที่ขาด ${result.gap.toLocaleString()} บาท ${result.metaphor ? '(' + result.metaphor + ')' : ''}

**คำแนะนำเฉพาะบุคคล:**
${result.recommendations.map((rec, i) => `${i+1}. ${rec}`).join('\n')}

**แผนดำเนินการ:**
${result.actionPlan}

**ข้อควรพิจารณาเพิ่มเติม:**
1. ควรมีเงินสำรองฉุกเฉิน 3-6 เท่าของรายจ่ายเดือน
2. พิจารณาประกันสุขภาพครอบคลุมโรคร้ายแรง
3. วางแผนการออมระยะยาวควบคู่กับประกันชีวิต
4. ตรวจสอบความคุ้มครองที่มีอยู่แล้วเป็นประจำ`;
                                break;

                            case "ice_breaking":
                                result = RuleBasedEngine.generateIceBreaking(formData, rhData, zone);
                                responseHTML = `### 🗣️ บทสนทนาเปิดใจ
                                
**บริบทพื้นที่:** ${zone} - ${result.tone}
**สถานที่พบกัน:** ${formData.location || "ร้านกาแฟ"}
**อายุ/อาชีพ:** ${formData.age || "35-40"} / ${formData.job || "อาชีพทั่วไป"}
**ระดับความสัมพันธ์:** ${formData.relationship_level || "ใหม่"}

**รูปแบบการเปิดบทสนทนา:**
${result.starters[0]}

**เชื่อมโยงกับอาชีพ:**
${result.jobConnection[0]}

**Hook เปิดใจ:**
${result.hook[0]}

${result.observationApproach ? `**แนวทางจากสิ่งที่สังเกตเห็น:**\n${result.observationApproach}\n` : ''}

**เคล็ดลับสำหรับพื้นที่${zone}:**
- ใช้ 'Local Common Ground': ${result.commonGround}
- ${result.tips.join('\n- ')}`;
                                break;

                            case "objection":
                                result = RuleBasedEngine.handleObjection(formData, rhData, zone);
                                responseHTML = `### 🛡️ เทคนิค LSCPA แก้ข้อโต้แย้ง
                                
**ข้อโต้แย้ง:** ${formData.type}
**คำพูดลูกค้า:** "${formData.direct_quote || 'ไม่ระบุ'}"
**น้ำเสียงลูกค้า:** ${formData.customer_tone || 'ไม่ระบุ'}

**เทคนิค:** ${result.technique}

**ขั้นตอน LSCPA:**
${result.steps.map((step, i) => `${i+1}. ${step}`).join('\n')}

${result.learnFromPrevious ? `**เรียนรู้จากครั้งก่อน:**\n${result.learnFromPrevious}\n` : ''}

**Reframing เทคนิค:**
${result.reframing}

${result.toneAdjustment ? `**ปรับน้ำเสียง:** ${result.toneAdjustment}\n` : ''}

**ปิดการสนทนา:**
${result.closing}`;
                                break;

                            case "simplifier":
                                result = RuleBasedEngine.simplifyPlan(formData, rhData, zone);
                                responseHTML = `### 💎 3 ประโยคทองคำย่อยแผนประกัน
                                
**แผนประกัน:** ${formData.plan_name || "แผนประกันทั่วไป"}
**เบี้ยประกัน:** ${parseFloat(formData.premium || 0).toLocaleString()} บาท/ปี

**เปรียบเทียบเบี้ยรายวัน:**
เบี้ยประกัน ${result.dailyCost} บาท/วัน ≈ ${result.localComparison} ใน${zone}
เบี้ยประกัน ${result.monthlyCost} บาท/เดือน

**3 ประโยคทองคำ:**
${result.goldenSentences.map((s, i) => `${i+1}. ${s}`).join('\n')}

**สรุปผลประโยชน์หลัก:**
${result.benefitSummary.map((b, i) => `${i+1}. ${b}`).join('\n')}

**กลยุทธ์การนำเสนอ:**
${result.competitorStrategy}

**คำแนะนำการนำเสนอ:**
${result.presentationTips.map((tip, i) => `${i+1}. ${tip}`).join('\n')}`;
                                break;

                            case "matchmaker":
                                result = RuleBasedEngine.matchProduct(formData, rhData, zone);
                                responseHTML = `### 🎯 แผนประกันที่เหมาะกับคุณ
                                
**เป้าหมาย:** ${formData.goal}
**งบประมาณ:** ${parseFloat(formData.budget || 0).toLocaleString()} บาท/ปี
**ระดับความสำคัญ:** ${formData.priority_level || "ปานกลาง"}

**แผนแนะนำ:** ${result.recommendedProduct.name}
**ความคุ้มครอง:** ${result.recommendedProduct.coverage}
**เบี้ยประกัน:** ${result.recommendedProduct.premium} บาท/ปี
**เหตุผล:** ${result.reason}
**ความเหมาะสมกับงบ:** ${result.budgetFit}

**วิเคราะห์สวัสดิการที่มีอยู่:**
${result.existingWelfare.map(w => `✅ ${w}`).join('\n')}

**ส่วนที่ควรเติมเต็ม:**
${result.missingCoverage.map(c => `➕ ${c}`).join('\n')}

**แผนดำเนินการ:**
${result.actionPlan}

**ขั้นตอนต่อไป:**
${result.nextSteps.map((step, i) => `${i+1}. ${step}`).join('\n')}`;
                                break;

                            case "closing":
                                result = RuleBasedEngine.generateClosing(formData, rhData, zone);
                                responseHTML = `### ✅ สรุปและปิดการขาย
                                
**จุดสนใจของลูกค้า:** ${formData.interest_point}
**ข้อกังวลสุดท้าย:** ${formData.last_concern}
**กรอบเวลา:** ${formData.timeline}
**ผู้ตัดสินใจ:** ${formData.decision_maker}

**สรุปจุดเด่น:**
"คุณให้ความสำคัญกับ${formData.interest_point} ซึ่งแผนนี้ตอบโจทย์คุณได้ดีเพราะ..."

**จัดการข้อกังวล:**
"สำหรับเรื่อง${formData.last_concern} ทางเรามีวิธีแก้โดย..."

**กลยุทธ์ตามกรอบเวลา:**
${result.timelineStrategy}

**กลยุทธ์ตามผู้ตัดสินใจ:**
${result.decisionMakerStrategy}

**ความเร่งด่วนเชิงพื้นที่:**
${result.urgency}

**เทคนิค Alternative Close:**
${result.closes.map((c, i) => `${i+1}. ${c}`).join('\n\n')}

**สร้างความมั่นใจ:**
${result.confidenceBuilder}

**ขั้นตอนถัดไป:**
${result.nextStep}`;
                                break;

                            case "prompt_library":
                                const category = this.state.promptLibrary.selectedCategory;
                                const prompts = RuleBasedEngine.getPromptLibrary(category);
                                const scripts = RuleBasedEngine.getConversationScripts("all");
                                
                                if (this.state.activeSubTab === "ready") {
                                    // Show ready-to-use prompts
                                    responseHTML = `### 📚 Prompt Library - ${this.getCategoryName(category)}
                                    
**Prompt สำเร็จรูปพร้อมใช้:**
${prompts.map(p => `
**${p.title}**
\`\`\`
${p.prompt}
\`\`\`
**หมวดหมู่:** ${p.category} | **แท็ก:** ${p.tags.join(', ')}
`).join('\n---\n')}

**สคริปต์บทสนทนาพร้อมใช้:**
${Object.entries(scripts).map(([type, scriptList]) => `
**${this.getScriptTypeName(type)}**
${scriptList.map(s => `
**${s.title}**
${s.script}
${s.tips ? `\n**เคล็ดลับ:** ${s.tips.join(', ')}` : ''}
${s.follow_up ? `\n**ติดตาม:** ${s.follow_up}` : ''}
${s.technique ? `\n**เทคนิค:** ${s.technique}` : ''}
${s.key_points ? `\n**จุดสำคัญ:** ${s.key_points.join(', ')}` : ''}
`).join('\n---\n')}
`).join('\n')}`;
                                } else {
                                    // Show custom prompt form
                                    responseHTML = `### 🛠️ สร้าง Prompt แบบ Customize
                                    
กรุณากรอกข้อมูลด้านซ้ายเพื่อสร้าง Prompt ที่เหมาะกับคุณ`;
                                }
                                break;

                            default:
                                responseHTML = "### ไม่พบข้อมูลสำหรับหมวดหมู่นี้";
                        }
                        
                        this.setState({ 
                            response: responseHTML,
                            loading: false
                        });
                    } catch (error) {
                        console.error("Error generating response:", error);
                        this.setState({ 
                            error: "เกิดข้อผิดพลาดในการวิเคราะห์: " + error.message,
                            loading: false 
                        });
                    }
                }, 800);
            }
            
            getCategoryName(category) {
                const names = {
                    "customer_analysis": "วิเคราะห์ลูกค้า",
                    "product_comparison": "เปรียบเทียบผลิตภัณฑ์",
                    "sales_script": "สคริปต์ขาย",
                    "objection_handling": "ตอบข้อโต้แย้ง"
                };
                return names[category] || category;
            }
            
            getScriptTypeName(type) {
                const names = {
                    "ice_breaking": "บทสนทนาเปิดใจ",
                    "objection_scenarios": "สถานการณ์ตอบข้อโต้แย้ง"
                };
                return names[type] || type;
            }
            
            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('คัดลอกลง Clipboard แล้ว');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            }
            
            renderInputSection() {
                const tab = this.state.activeTab;
                const f = this.state.forms[tab];
                
                const createInput = (tabName, field, value, placeholder, type = "text", extraClass = "") => {
                    const id = `${tabName}-${field}`;
                    return `
                        <input 
                            id="${id}"
                            type="${type}" 
                            class="w-full p-3 border rounded-lg bg-slate-50 text-base ${extraClass}"
                            value="${value}"
                            oninput="app.handleInputChange('${tabName}', '${field}', this.value)"
                            placeholder="${placeholder}"
                            autocomplete="off"
                        >
                    `;
                };
                
                const createTextarea = (tabName, field, value, placeholder, rows = 4) => {
                    const id = `${tabName}-${field}`;
                    return `
                        <textarea 
                            id="${id}"
                            class="w-full p-3 border rounded-lg bg-slate-50 text-base resize-none"
                            rows="${rows}"
                            oninput="app.handleInputChange('${tabName}', '${field}', this.value)"
                            placeholder="${placeholder}"
                            autocomplete="off"
                        >${value}</textarea>
                    `;
                };
                
                const createSelect = (tabName, field, value, options, placeholder = "เลือก") => {
                    const id = `${tabName}-${field}`;
                    let optionsHtml = `<option value="">${placeholder}</option>`;
                    
                    if (Array.isArray(options)) {
                        options.forEach(option => {
                            const isSelected = option === value ? 'selected' : '';
                            optionsHtml += `<option value="${option}" ${isSelected}>${option}</option>`;
                        });
                    } else if (typeof options === 'object') {
                        Object.entries(options).forEach(([key, label]) => {
                            const isSelected = key === value ? 'selected' : '';
                            optionsHtml += `<option value="${key}" ${isSelected}>${label}</option>`;
                        });
                    }
                    
                    return `
                        <select 
                            id="${id}"
                            class="w-full p-3 border rounded-lg bg-slate-50 text-base"
                            onchange="app.handleInputChange('${tabName}', '${field}', this.value)"
                        >
                            ${optionsHtml}
                        </select>
                    `;
                };
                
                const InputWrap = (label, children) => `
                    <div class="mb-4">
                        <label class="block text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-2 ml-1">${label}</label>
                        ${children}
                    </div>
                `;
                
                switch (tab) {
                    case "needs_analysis":
                        const { gap } = this.calculateRealityCheck();
                        return `
                            <div class="space-y-4 animate-in">
                                <div class="grid grid-cols-2 gap-3">
                                    ${InputWrap("รายได้ต่อปี (บาท)", 
                                        createInput('needs_analysis', 'income', f.income, "0", "number")
                                    )}
                                    ${InputWrap("รายจ่าย/เดือน", 
                                        createInput('needs_analysis', 'expense', f.expense, "0", "number")
                                    )}
                                </div>
                                ${InputWrap("หนี้สินรวม (บ้าน/รถ/ธุรกิจ)", 
                                    createInput('needs_analysis', 'debt', f.debt, "0", "number")
                                )}
                                <div class="grid grid-cols-2 gap-3">
                                    ${InputWrap("คนในอุปการะ", 
                                        createInput('needs_analysis', 'dependents', f.dependents, "คน", "number")
                                    )}
                                    ${InputWrap("จำนวนปีที่ต้องดูแล", 
                                        createInput('needs_analysis', 'years', f.years, "ปี", "number")
                                    )}
                                </div>
                                ${InputWrap("สินทรัพย์เดิม (เงินออม/ทุนประกัน)", 
                                    createInput('needs_analysis', 'assets', f.assets, "0", "number")
                                )}
                                ${InputWrap("ประกันที่มีอยู่แล้ว", 
                                    createTextarea('needs_analysis', 'insurance_existing', f.insurance_existing, "ระบุประเภทและวงเงิน", 3)
                                )}
                                ${InputWrap("จุดที่รู้สึกว่าคุ้มครองไม่พอ", 
                                    createTextarea('needs_analysis', 'insurance_gap', f.insurance_gap, "เช่น โรคร้ายแรง, รายได้ทดแทน", 3)
                                )}
                                <div class="bg-gradient-to-r from-amber-900 to-orange-900 rounded-xl p-4 text-white shadow-lg">
                                    <div class="flex justify-between items-center text-[11px] opacity-80 mb-1">
                                        <span>ESTIMATED PROTECTION GAP</span>
                                        ${ICONS.alert}
                                    </div>
                                    <div id="protection-gap" class="text-xl font-bold">${gap.toLocaleString()} บาท</div>
                                    <div class="text-[10px] opacity-60 mt-1">Rule-based Analysis</div>
                                </div>
                            </div>
                        `;
                    
                    case "ice_breaking":
                        const relationshipOptions = {
                            "ใหม่": "ใหม่ (เพิ่งรู้จัก)",
                            "พอคุ้นเคย": "พอคุ้นเคย",
                            "สนิท": "สนิท (รู้จักกันมานาน)"
                        };
                        
                        return `
                            <div class="space-y-4 animate-in">
                                <div class="grid grid-cols-2 gap-3">
                                    ${InputWrap("ช่วงอายุลูกค้า", 
                                        createInput('ice_breaking', 'age', f.age, "เช่น 35-40 ปี")
                                    )}
                                    ${InputWrap("อาชีพ", 
                                        createInput('ice_breaking', 'job', f.job, "เช่น วิศวกร")
                                    )}
                                </div>
                                ${InputWrap("สถานที่ที่พบกัน", 
                                    createInput('ice_breaking', 'location', f.location, "เช่น ร้านกาแฟในนิคมฯ")
                                )}
                                ${InputWrap("ระดับความสัมพันธ์", 
                                    createSelect('ice_breaking', 'relationship_level', f.relationship_level, relationshipOptions)
                                )}
                                ${InputWrap("สิ่งที่สังเกตเห็น (Insight)", 
                                    createTextarea('ice_breaking', 'observation', f.observation, "เช่น ใส่สมาร์ทวอทช์, ดูรีบไปรับลูก, ถือหนังสือลงทุน", 4)
                                )}
                                ${InputWrap("ความสนใจร่วม", 
                                    createInput('ice_breaking', 'common_interest', f.common_interest, "เช่น กีฬา, การลงทุน, ท่องเที่ยว")
                                )}
                            </div>
                        `;
                    
                    case "objection":
                        const objectionOptions = {
                            "เงินไม่พอ": "เงินไม่พอ",
                            "มีประกันเยอะแล้ว": "มีประกันเยอะแล้ว",
                            "ขอถามแฟน/ครอบครัวก่อน": "ขอถามแฟน/ครอบครัวก่อน",
                            "ประกันโกง/เบิกยาก": "ประกันโกง/เบิกยาก",
                            "ยังไม่รีบ/ยังแข็งแรง": "ยังไม่รีบ/ยังแข็งแรง",
                            "ไม่ไว้ใจตัวแทน": "ไม่ไว้ใจตัวแทน",
                            "รอโบนัส/รอเงินก้อน": "รอโบนัส/รอเงินก้อน"
                        };
                        
                        const toneOptions = {
                            "กังวล": "กังวล",
                            "ไม่มั่นใจ": "ไม่มั่นใจ",
                            "สงสัย": "สงสัย",
                            "ปฏิเสธ": "ปฏิเสธ",
                            "เหนื่อย": "เหนื่อย"
                        };
                        
                        return `
                            <div class="space-y-4">
                                ${InputWrap("ข้อโต้แย้งที่พบ", 
                                    createSelect('objection', 'type', f.type, objectionOptions, "เลือกประเภทข้อโต้แย้ง")
                                )}
                                ${InputWrap("น้ำเสียงลูกค้า", 
                                    createSelect('objection', 'customer_tone', f.customer_tone, toneOptions, "เลือกน้ำเสียง")
                                )}
                                ${InputWrap("คำพูดดิบๆ ของลูกค้า (Direct Quote)", 
                                    createTextarea('objection', 'direct_quote', f.direct_quote, "เช่น 'น้องคะ ช่วงนี้พี่ผ่อนบ้านเยอะ ไม่ไหวจริงๆ'", 5)
                                )}
                                ${InputWrap("เคยลองแก้ไขอย่างไรแล้ว", 
                                    createTextarea('objection', 'previous_attempts', f.previous_attempts, "บอกว่าคุ้มครองโรคร้ายแรง, เปรียบเทียบเบี้ยรายวัน", 3)
                                )}
                                <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800">
                                    <strong>Tip:</strong> ระบบวิเคราะห์จากฐานข้อมูลเทคนิค LSCPA และตัวอย่างในพื้นที่
                                </div>
                            </div>
                        `;
                    
                    case "simplifier":
                        const competitorOptions = {
                            "รู้จักชื่อคู่แข่ง": "รู้จักชื่อคู่แข่ง",
                            "ไม่รู้จัก": "ไม่รู้จัก",
                            "เคยได้ยิน": "เคยได้ยิน"
                        };
                        
                        return `
                            <div class="space-y-4">
                                ${InputWrap("ชื่อแผนประกัน", 
                                    createInput('simplifier', 'plan_name', f.plan_name, "เช่น ttb Easy Care")
                                )}
                                ${InputWrap("เบี้ยประกันต่อปี (บาท)", 
                                    createInput('simplifier', 'premium', f.premium, "0", "number")
                                )}
                                ${InputWrap("ผลประโยชน์หลัก (ระบุ 3-5 ข้อ)", 
                                    createTextarea('simplifier', 'benefits', f.benefits, "1. คุ้มครองผู้ป่วยใน...\\n2. เหมาจ่ายค่ารักษา...", 5)
                                )}
                                ${InputWrap("รู้จักคู่แข่งหรือไม่", 
                                    createSelect('simplifier', 'competitor_comparison', f.competitor_comparison, competitorOptions)
                                )}
                                ${InputWrap("จุดเด่นที่อยากเน้น", 
                                    createTextarea('simplifier', 'unique_selling_point', f.unique_selling_point, "เช่น จ่ายง่าย, เงื่อนไขน้อย, ความคุ้มครองครบ", 3)
                                )}
                            </div>
                        `;
                    
                    case "matchmaker":
                        const goalOptions = {
                            "ลดหย่อนภาษี": "ลดหย่อนภาษี",
                            "มรดกให้ลูกหลาน": "มรดกให้ลูกหลาน",
                            "ค่ารักษาพยาบาล (สุขภาพ)": "ค่ารักษาพยาบาล (สุขภาพ)",
                            "เงินออม/เกษียณ": "เงินออม/เกษียณ",
                            "รายได้ทดแทน": "รายได้ทดแทน",
                            "โรคร้ายแรง": "โรคร้ายแรง"
                        };
                        
                        const priorityOptions = {
                            "สูง": "สูง (เร่งด่วน)",
                            "ปานกลาง": "ปานกลาง",
                            "ต่ำ": "ต่ำ (วางแผนล่วงหน้า)"
                        };
                        
                        return `
                            <div class="space-y-4">
                                ${InputWrap("เป้าหมายหลัก", 
                                    createSelect('matchmaker', 'goal', f.goal, goalOptions, "เลือกเป้าหมาย")
                                )}
                                ${InputWrap("งบประมาณที่ชำระได้สะดวก (ต่อปี)", 
                                    createInput('matchmaker', 'budget', f.budget, "เช่น 30,000", "number")
                                )}
                                ${InputWrap("ความคุ้มครองที่มีอยู่แล้ว", 
                                    createTextarea('matchmaker', 'existing_coverage', f.existing_coverage, "เช่น ประกันสังคม, ประกันกลุ่มบริษัท", 3)
                                )}
                                ${InputWrap("ระดับความสำคัญ", 
                                    createSelect('matchmaker', 'priority_level', f.priority_level, priorityOptions)
                                )}
                                <div class="p-3 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-100 flex items-start gap-3">
                                    ${ICONS.zap}
                                    <p class="text-xs text-amber-800 leading-relaxed">ระบบจะแนะนำแผนโดยอ้างอิงสวัสดิการพื้นฐานของคนในโซน <b>${this.state.userProfile.zone}</b> เป็นหลัก</p>
                                </div>
                            </div>
                        `;
                    
                    case "closing":
                        const timelineOptions = {
                            "ภายในสัปดาห์นี้": "ภายในสัปดาห์นี้",
                            "ภายในเดือนนี้": "ภายในเดือนนี้",
                            "ยังไม่แน่ใจ": "ยังไม่แน่ใจ",
                            "วางแผนล่วงหน้า": "วางแผนล่วงหน้า"
                        };
                        
                        return `
                            <div class="space-y-4">
                                ${InputWrap("จุดที่ลูกค้าดูสนใจมากที่สุด", 
                                    createInput('closing', 'interest_point', f.interest_point, "เช่น การคุ้มครองโรคร้ายแรง")
                                )}
                                ${InputWrap("ข้อกังวลสุดท้ายที่ลูกค้าลังเล", 
                                    createTextarea('closing', 'last_concern', f.last_concern, "เช่น กลัวอนาคตส่งไม่ไหว", 5)
                                )}
                                ${InputWrap("กรอบเวลาที่ลูกค้าบอก", 
                                    createSelect('closing', 'timeline', f.timeline, timelineOptions)
                                )}
                                ${InputWrap("ผู้มีส่วนร่วมตัดสินใจ", 
                                    createInput('closing', 'decision_maker', f.decision_maker, "เช่น ตัวเอง, คู่สมรส, ผู้ปกครอง")
                                )}
                            </div>
                        `;
                    
                    case "prompt_library":
                        const promptCategories = {
                            "customer_analysis": "วิเคราะห์ลูกค้า",
                            "product_comparison": "เปรียบเทียบผลิตภัณฑ์",
                            "sales_script": "สคริปต์ขาย",
                            "objection_handling": "ตอบข้อโต้แย้ง"
                        };
                        
                        const currentCategory = this.state.promptLibrary.selectedCategory;
                        
                        return `
                            <div class="space-y-4">
                                <div class="flex space-x-2 mb-4">
                                    <button onclick="app.setState({ activeSubTab: 'ready' })" class="flex-1 py-2 px-4 rounded-lg ${this.state.activeSubTab === 'ready' ? 'bg-gradient-to-r from-amber-600 to-orange-600 text-white' : 'bg-slate-100 text-slate-600'} font-medium">
                                        Prompt สำเร็จรูป
                                    </button>
                                    <button onclick="app.setState({ activeSubTab: 'custom' })" class="flex-1 py-2 px-4 rounded-lg ${this.state.activeSubTab === 'custom' ? 'bg-gradient-to-r from-amber-600 to-orange-600 text-white' : 'bg-slate-100 text-slate-600'} font-medium">
                                        สร้าง Prompt
                                    </button>
                                </div>
                                
                                ${this.state.activeSubTab === 'ready' ? `
                                    ${InputWrap("เลือกหมวดหมู่", 
                                        createSelect('prompt_library', 'category', currentCategory, promptCategories)
                                    )}
                                    
                                    <div class="mt-6">
                                        <h4 class="text-sm font-bold text-slate-700 mb-3">📖 Prompt Library</h4>
                                        <div class="space-y-3 max-h-80 overflow-y-auto custom-scrollbar">
                                            ${RuleBasedEngine.getPromptLibrary(currentCategory).map(prompt => `
                                                <div class="p-3 bg-slate-50 border rounded-lg hover:bg-amber-50 cursor-pointer" onclick="app.copyToClipboard('${prompt.prompt.replace(/'/g, "\\'")}')">
                                                    <div class="font-bold text-slate-800 text-sm">${prompt.title}</div>
                                                    <div class="text-xs text-slate-600 mt-1 truncate">${prompt.prompt.substring(0, 80)}...</div>
                                                    <div class="flex items-center gap-2 mt-2">
                                                        <span class="text-[10px] bg-slate-200 text-slate-700 px-2 py-0.5 rounded">${prompt.category}</span>
                                                        ${prompt.tags.map(tag => `
                                                            <span class="text-[10px] bg-amber-100 text-amber-800 px-2 py-0.5 rounded">${tag}</span>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : `
                                    ${InputWrap("วัตถุประสงค์", 
                                        createInput('prompt_library', 'custom_objective', f.custom_objective, "เช่น สร้างบทสนทนาแนะนำประกันสุขภาพ")
                                    )}
                                    ${InputWrap("กลุ่มเป้าหมาย", 
                                        createInput('prompt_library', 'custom_target', f.custom_target, "เช่น เจ้าของสวนยางในกระบี่")
                                    )}
                                    ${InputWrap("รายละเอียดที่ต้องการ", 
                                        createTextarea('prompt_library', 'custom_details', f.custom_details, "ชื่อโรงพยาบาล, ชื่อแผนประกัน, เป้าหมายเฉพาะ...", 4)
                                    )}
                                    
                                    <div class="p-3 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-100">
                                        <p class="text-xs text-amber-800">
                                            <strong>Tip:</strong> Prompt ที่ดีควรระบุ Role, Task, Context และ Output format ให้ชัดเจน
                                        </p>
                                    </div>
                                `}
                            </div>
                        `;
                    
                    default:
                        return `<div class="text-center text-slate-500 p-8">เลือกหมวดหมู่เพื่อเริ่มต้น</div>`;
                }
            }
            
            renderSetupPage() {
                const rhOptions = Object.keys(RH_DATA).map(rh => 
                    `<option value="${rh}" ${this.state.userProfile.rh === rh ? 'selected' : ''}>${rh}</option>`
                ).join('');
                
                const zoneOptions = this.state.userProfile.rh 
                    ? ZONES[this.state.userProfile.rh].map(z => 
                        `<option value="${z}" ${this.state.userProfile.zone === z ? 'selected' : ''}>${z}</option>`
                      ).join('')
                    : '';
                
                return `
                    <div class="fixed-height bg-gradient-to-br from-slate-900 to-slate-950 flex items-center justify-center p-4 overflow-auto">
                        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6 md:p-8 overflow-hidden relative">
                            <div class="absolute top-0 right-0 p-4 opacity-5">
                                ${ICONS.sparkles.replace('icon-warning', '').replace('fa-sparkles', 'fa-star')}
                            </div>
                            
                            <div class="flex flex-col items-center mb-6 relative">
                                <div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-xl">
                                    ${ICONS.sparkles.replace('icon-warning', 'text-white')}
                                </div>
                                <h1 class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight">MAMA V.2</h1>
                                <p class="text-[10px] bg-gradient-to-r from-amber-600 to-orange-600 bg-clip-text text-transparent font-bold tracking-[0.2em] uppercase mt-1">Sale Assistant</p>
                                <div class="orange-badge mt-2">
                                    ${ICONS.library} RULE-BASED SYSTEM
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-2 ml-1">REGION (RH)</label>
                                        <select 
                                            id="rh-select"
                                            value="${this.state.userProfile.rh}" 
                                            onchange="app.setState({ userProfile: { ...app.state.userProfile, rh: this.value } })"
                                            class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-amber-500 outline-none text-base">
                                            <option value="">เลือก RH</option>
                                            ${rhOptions}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-2 ml-1">ZONE</label>
                                        <select 
                                            id="zone-select"
                                            value="${this.state.userProfile.zone}" 
                                            onchange="app.setState({ userProfile: { ...app.state.userProfile, zone: this.value } })"
                                            ${!this.state.userProfile.rh ? 'disabled' : ''}
                                            class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-amber-500 outline-none text-base ${!this.state.userProfile.rh ? 'bg-slate-50' : ''}">
                                            <option value="">เลือกโซน</option>
                                            ${zoneOptions}
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200">
                                    <div class="flex items-center gap-2 mb-2">
                                        ${ICONS.lightbulb}
                                        <span class="font-bold text-amber-800">ระบบ Rule-based</span>
                                    </div>
                                    <p class="text-xs text-amber-700">
                                        ระบบวิเคราะห์ด้วยกฎและฐานข้อมูลในระบบ โดยไม่ต้องใช้ AI เหมาะสำหรับผู้ที่ต้องการคำแนะนำจากฐานข้อมูลและประสบการณ์จริง
                                    </p>
                                </div>
                                
                                <button 
                                    onclick="if(app.state.userProfile.zone) app.setState({ isSetup: true }); else alert('กรุณาเลือกโซนให้ครบ')"
                                    class="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-bold py-4 rounded-xl transition-all mt-2 flex items-center justify-center gap-2 shadow-lg shadow-amber-900/20 active:scale-95 transform transition-transform">
                                    เริ่มใช้งานระบบ ${ICONS.chevronRight}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderMainPage() {
                const tabs = [
                    { id: 'needs_analysis', label: '1. วิเคราะห์ความต้องการ', icon: ICONS.calculator },
                    { id: 'ice_breaking', label: '2. บทสนทนาเปิดใจ', icon: ICONS.message },
                    { id: 'objection', label: '3. ทลายข้อโต้แย้ง', icon: ICONS.shield },
                    { id: 'simplifier', label: '4. ย่อยผลประโยชน์', icon: ICONS.gift },
                    { id: 'matchmaker', label: '5. เลือกผลิตภัณฑ์', icon: ICONS.bag },
                    { id: 'closing', label: '6. สรุปและปิดการขาย', icon: ICONS.file },
                    { id: 'prompt_library', label: '7. Prompt Library', icon: ICONS.library },
                ];
                
                const rh = RH_DATA[this.state.userProfile.rh] || {};
                const zone = this.state.userProfile.zone;
                
                return `
                    <div class="fixed-height flex flex-col md:flex-row overflow-hidden">
                        <!-- Sidebar -->
                        <aside class="w-full md:w-72 bg-gradient-to-b from-slate-900 to-slate-950 text-white flex flex-col flex-shrink-0 z-30 shadow-2xl">
                            <div class="p-4 md:p-6 border-b border-white/5 flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center text-white">
                                    ${ICONS.sparkles.replace('icon-warning', 'text-white')}
                                </div>
                                <div>
                                    <span class="font-black text-xl block leading-none">MAMA <span class="bg-gradient-to-r from-amber-400 to-orange-400 bg-clip-text text-transparent">V.2</span></span>
                                    <span class="text-[8px] text-slate-500 font-bold tracking-[0.2em]">PRU ACADEMY [ttb]</span>
                                </div>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto p-3 md:p-4 space-y-1.5 custom-scrollbar">
                                ${tabs.map(tab => `
                                    <button
                                        onclick="app.setState({ activeTab: '${tab.id}', response: '', activeSubTab: 'input' })"
                                        class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl transition-all group ${this.state.activeTab === tab.id ? 'bg-gradient-to-r from-amber-600 to-orange-600 text-white shadow-lg' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                                        ${tab.icon}
                                        <span class="text-[13px] font-bold">${tab.label}</span>
                                    </button>
                                `).join('')}
                            </div>
                            
                            <div class="p-4 bg-black/20 border-t border-white/5">
                                <div class="bg-slate-800/50 rounded-2xl p-4 relative overflow-hidden">
                                    <div class="text-[10px] text-slate-500 font-bold mb-2 flex items-center gap-1 uppercase">
                                        ${ICONS.map} ${zone}
                                    </div>
                                    <div class="text-xs font-bold mb-1 truncate">${rh.name || 'กรุณาเลือกภูมิภาค'}</div>
                                    <div class="text-[10px] text-slate-400 italic">"${rh.tone || 'เลือกภูมิภาคเพื่อดูรายละเอียด'}"</div>
                                    <div class="mt-2 text-[9px] bg-gradient-to-r from-amber-900 to-orange-900 text-amber-200 px-2 py-1 rounded-full inline-flex items-center gap-1">
                                        ${ICONS.library} RULE-BASED
                                    </div>
                                    <button onclick="app.setState({ isSetup: false })" class="absolute top-2 right-2 text-slate-600 hover:text-amber-400">
                                        ${ICONS.rotate}
                                    </button>
                                </div>
                            </div>
                        </aside>
                        
                        <!-- Main Content -->
                        <main class="flex-1 flex flex-col overflow-hidden relative">
                            <!-- Header -->
                            <header class="bg-white px-4 md:px-8 py-4 md:py-5 border-b flex justify-between items-center z-10">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3">
                                        <h2 class="text-lg md:text-xl font-black text-slate-800">
                                            ${this.state.activeTab.replace('_', ' ').toUpperCase()}
                                            ${this.state.activeTab === 'prompt_library' ? ` (${this.state.activeSubTab === 'ready' ? 'สำเร็จรูป' : 'สร้างเอง'})` : ''}
                                        </h2>
                                        <div class="orange-badge text-xs">
                                            ${ICONS.library} RULE-BASED
                                        </div>
                                    </div>
                                    <div class="flex gap-2 mt-1">
                                        ${rh.keywords ? rh.keywords.slice(0, 2).map(k => `
                                            <span class="text-[9px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-bold">#${k}</span>
                                        `).join('') : ''}
                                    </div>
                                </div>
                                ${this.state.activeTab !== 'prompt_library' || this.state.activeSubTab !== 'ready' ? `
                                <button 
                                    onclick="app.generateResponse()"
                                    ${this.state.loading ? 'disabled' : ''}
                                    class="px-4 md:px-8 py-2 md:py-3 rounded-xl font-black transition-all flex items-center gap-2 shadow-xl ${this.state.loading ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-gradient-to-r from-amber-600 to-orange-600 text-white hover:from-amber-700 hover:to-orange-700 shadow-amber-900/10 active:scale-95 transform transition-transform'}"
                                    style="min-width: 140px;">
                                    ${this.state.loading ? 
                                        '<i class="fas fa-spinner fa-spin"></i>' : 
                                        ICONS.sparkles.replace('icon-warning', 'text-white')}
                                    <span class="hidden md:inline">${this.state.loading ? 'วิเคราะห์...' : 'วิเคราะห์'}</span>
                                    <span class="md:hidden">${this.state.loading ? '...' : 'วิเคราะห์'}</span>
                                </button>
                                ` : ''}
                            </header>
                            
                            <div class="flex-1 flex overflow-hidden">
                                <!-- Left: Input Panel -->
                                <div class="w-full md:w-80 bg-white border-r overflow-y-auto p-4 md:p-6 flex-shrink-0 custom-scrollbar">
                                    <div class="mb-6 flex items-center justify-between">
                                        <h4 class="text-[11px] font-black text-slate-500 uppercase tracking-widest">Inputs</h4>
                                        ${ICONS.trending}
                                    </div>
                                    <div id="input-section">
                                        ${this.renderInputSection()}
                                    </div>
                                    
                                    <!-- Region Insights -->
                                    <div class="mt-8 pt-8 border-t space-y-4">
                                        <div class="flex items-center gap-2 bg-gradient-to-r from-amber-600 to-orange-600 bg-clip-text text-transparent">
                                            ${ICONS.building}
                                            <span class="text-[11px] font-black uppercase tracking-wider">Local Insight</span>
                                        </div>
                                        <div class="p-4 bg-slate-50 rounded-2xl border">
                                            <p class="text-sm text-slate-600 leading-relaxed italic">"${rh.dynamics || 'กรุณาเลือกภูมิภาค'}"</p>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex items-center gap-2 bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent">
                                                ${ICONS.stethoscope}
                                                <span class="text-[11px] font-black uppercase tracking-wider">Top Hospitals</span>
                                            </div>
                                            <div class="flex flex-wrap gap-1.5">
                                                ${rh.hospitals ? rh.hospitals.map(h => `
                                                    <span class="text-[10px] bg-white border px-2 py-1 rounded-lg text-slate-500 font-bold">${h}</span>
                                                `).join('') : '<span class="text-[10px] text-slate-400">กรุณาเลือกภูมิภาค</span>'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right: Output Panel -->
                                <div class="flex-1 bg-gradient-to-br from-slate-50 to-white overflow-y-auto custom-scrollbar relative">
                                    ${this.renderOutputPanel()}
                                </div>
                            </div>
                        </main>
                    </div>
                `;
            }
            
            renderOutputPanel() {
                if (!this.state.response && this.state.activeTab !== 'prompt_library') {
                    return `
                        <div class="h-full flex flex-col items-center justify-center opacity-20 select-none px-6 md:px-12 text-center py-12">
                            <div class="w-24 h-24 md:w-32 md:h-32 bg-gradient-to-br from-slate-200 to-slate-300 rounded-full flex items-center justify-center mb-6 shadow-inner">
                                ${ICONS.sparkles.replace('icon-warning', 'text-slate-400')}
                            </div>
                            <h3 class="text-xl md:text-3xl font-black tracking-tight bg-gradient-to-r from-slate-400 to-slate-600 bg-clip-text text-transparent">MAMA READY</h3>
                            <p class="mt-2 text-slate-500 max-w-sm text-sm md:text-base">
                                กรอกข้อมูลในช่อง Input ทางซ้าย แล้วกด "วิเคราะห์"<br>
                                <span class="text-xs text-amber-600 font-bold mt-2 inline-block">ระบบวิเคราะห์ด้วยกฎและฐานข้อมูลในระบบ</span>
                            </p>
                            ${this.state.error ? `
                                <div class="mt-8 p-4 bg-red-50 text-red-600 border border-red-200 rounded-2xl text-xs font-bold w-full max-w-md">
                                    ${this.state.error}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // For prompt library ready tab
                if (this.state.activeTab === 'prompt_library' && this.state.activeSubTab === 'ready') {
                    const category = this.state.promptLibrary.selectedCategory;
                    const prompts = RuleBasedEngine.getPromptLibrary(category);
                    const scripts = RuleBasedEngine.getConversationScripts("all");
                    
                    return `
                        <div class="max-w-3xl mx-auto p-4 md:p-8 lg:p-12 pb-20 md:pb-32 slide-in-from-bottom">
                            <!-- Header -->
                            <div class="mb-6 flex justify-center">
                                <div class="orange-badge text-sm">
                                    ${ICONS.library} PROMPT LIBRARY - ${this.getCategoryName(category).toUpperCase()}
                                </div>
                            </div>
                            
                            <!-- Prompt Library Content -->
                            <div class="space-y-8">
                                <!-- Ready-to-use Prompts -->
                                <div>
                                    <h3 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2 border-l-4 border-amber-500 pl-4">
                                        ${ICONS.copy} Prompt สำเร็จรูปพร้อมใช้
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${prompts.map(prompt => `
                                            <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition-shadow">
                                                <div class="flex justify-between items-start mb-3">
                                                    <h4 class="font-bold text-slate-800">${prompt.title}</h4>
                                                    <button onclick="app.copyToClipboard('${prompt.prompt.replace(/'/g, "\\'")}')" class="text-amber-600 hover:text-amber-800">
                                                        ${ICONS.copy}
                                                    </button>
                                                </div>
                                                <div class="bg-slate-50 p-3 rounded-lg font-mono text-sm text-slate-700 mb-3">
                                                    ${prompt.prompt}
                                                </div>
                                                <div class="flex flex-wrap gap-1.5">
                                                    <span class="text-[10px] bg-slate-100 text-slate-700 px-2 py-1 rounded">${prompt.category}</span>
                                                    ${prompt.tags.map(tag => `
                                                        <span class="text-[10px] bg-amber-100 text-amber-800 px-2 py-1 rounded">${tag}</span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- Conversation Scripts -->
                                ${Object.entries(scripts).map(([type, scriptList]) => `
                                    <div>
                                        <h3 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2 border-l-4 border-orange-500 pl-4">
                                            ${ICONS.script} ${this.getScriptTypeName(type)}
                                        </h3>
                                        <div class="space-y-4">
                                            ${scriptList.map(script => `
                                                <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm">
                                                    <div class="flex justify-between items-start mb-3">
                                                        <h4 class="font-bold text-slate-800">${script.title}</h4>
                                                        <button onclick="app.copyToCliptext('${script.script.replace(/'/g, "\\'")}')" class="text-orange-600 hover:text-orange-800">
                                                            ${ICONS.copy}
                                                        </button>
                                                    </div>
                                                    <div class="bg-amber-50 p-4 rounded-lg mb-3">
                                                        <div class="text-sm text-slate-700 whitespace-pre-line">${script.script}</div>
                                                    </div>
                                                    ${script.tips ? `
                                                        <div class="mb-2">
                                                            <span class="text-xs font-bold text-slate-600">เคล็ดลับ:</span>
                                                            <div class="text-xs text-slate-600 mt-1">${script.tips.join(', ')}</div>
                                                        </div>
                                                    ` : ''}
                                                    ${script.follow_up ? `
                                                        <div class="mb-2">
                                                            <span class="text-xs font-bold text-slate-600">ติดตาม:</span>
                                                            <div class="text-xs text-slate-600 mt-1">${script.follow_up}</div>
                                                        </div>
                                                    ` : ''}
                                                    ${script.technique ? `
                                                        <div class="mb-2">
                                                            <span class="text-xs font-bold text-slate-600">เทคนิค:</span>
                                                            <div class="text-xs text-slate-600 mt-1">${script.technique}</div>
                                                        </div>
                                                    ` : ''}
                                                    ${script.key_points ? `
                                                        <div class="mb-2">
                                                            <span class="text-xs font-bold text-slate-600">จุดสำคัญ:</span>
                                                            <div class="text-xs text-slate-600 mt-1">${script.key_points.join(', ')}</div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- Footer Note -->
                            <div class="mt-8 p-4 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl">
                                <div class="flex items-center gap-2 mb-2">
                                    ${ICONS.lightbulb}
                                    <span class="font-bold text-amber-800">คำแนะนำการใช้งาน</span>
                                </div>
                                <p class="text-xs text-amber-700">
                                    คลิกที่ไอคอน Copy เพื่อคัดลอก Prompt หรือสคริปต์ไปใช้งานได้ทันที
                                    หรือไปที่แท็บ "สร้าง Prompt" เพื่อออกแบบ Prompt ที่เหมาะกับความต้องการเฉพาะของคุณ
                                </p>
                            </div>
                        </div>
                    `;
                }
                
                // แปลงรูปแบบ markdown เป็น HTML อย่างง่าย
                const formatResponse = (text) => {
                    return text
                        .replace(/\n\n/g, '<br><br>')
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-900">$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/### (.*?)(<br>|$)/g, '<h3 class="text-lg font-black text-slate-900 mt-6 mb-3 flex items-center gap-2 border-l-4 border-amber-500 pl-4">$1</h3>')
                        .replace(/- (.*?)(<br>|$)/g, '<li class="ml-4 mb-2 flex items-start"><span class="text-amber-500 mr-2">•</span> $1</li>')
                        .replace(/`(.*?)`/g, '<code class="bg-slate-100 text-slate-700 px-2 py-1 rounded font-mono text-sm">$1</code>')
                        .replace(/\+\+ (.*?)(<br>|$)/g, '<li class="ml-4 mb-2 flex items-start"><span class="text-emerald-500 mr-2">+</span> $1</li>')
                        .replace(/✅ (.*?)(<br>|$)/g, '<li class="ml-4 mb-2 flex items-start"><span class="text-emerald-500 mr-2">✓</span> $1</li>')
                        .replace(/❌ (.*?)(<br>|$)/g, '<li class="ml-4 mb-2 flex items-start"><span class="text-red-500 mr-2">✗</span> $1</li>');
                };
                
                return `
                    <div class="max-w-3xl mx-auto p-4 md:p-8 lg:p-12 pb-20 md:pb-32 slide-in-from-bottom">
                        <!-- Rule-based Badge -->
                        <div class="mb-6 flex justify-center">
                            <div class="orange-badge text-sm">
                                ${ICONS.library} RULE-BASED ANALYSIS
                            </div>
                        </div>
                        
                        <!-- Result Wrapper -->
                        <div class="bg-white rounded-2xl md:rounded-[2rem] shadow-2xl shadow-slate-200 overflow-hidden border border-white">
                            <!-- Result Header -->
                            <div class="bg-gradient-to-r from-amber-600 to-orange-600 px-6 md:px-10 py-4 md:py-6 text-white flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 md:w-10 md:h-10 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                                        ${ICONS.lightbulb.replace('icon-warning', 'text-white')}
                                    </div>
                                    <div>
                                        <div class="text-[10px] font-bold text-amber-300 uppercase tracking-[0.2em]">ANALYSIS RESULT</div>
                                        <div class="text-sm font-bold opacity-90">${this.state.activeTab.replace('_', ' ').toUpperCase()}</div>
                                    </div>
                                </div>
                                <button onclick="app.copyToClipboard('${this.state.response.replace(/'/g, "\\'").replace(/\n/g, '\\n')}'); alert('คัดลอกลง Clipboard แล้ว');" class="w-8 h-8 md:w-10 md:h-10 bg-white/10 hover:bg-white/20 rounded-xl flex items-center justify-center transition-colors backdrop-blur-sm">
                                    ${ICONS.copy.replace('icon-gray', 'text-white')}
                                </button>
                            </div>
                            
                            <!-- Result Content -->
                            <div class="p-6 md:p-10 text-slate-700 leading-relaxed text-sm md:text-base overflow-wrap-break">
                                ${formatResponse(this.state.response)}
                                
                                <!-- Rule-based Disclaimer -->
                                <div class="mt-8 p-4 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl">
                                    <div class="flex items-center gap-2 mb-2">
                                        ${ICONS.library}
                                        <span class="font-bold text-amber-800">หมายเหตุระบบ Rule-based</span>
                                    </div>
                                    <p class="text-xs text-amber-700">
                                        ผลการวิเคราะห์นี้สร้างจากกฎและฐานข้อมูลที่กำหนดไว้ในระบบ โดยอ้างอิงข้อมูลพื้นที่ ${this.state.userProfile.zone} และฐานข้อมูลผลิตภัณฑ์ประกัน
                                        ระบบนี้ไม่ใช้ AI ในการประมวลผล แต่ใช้กฎและเงื่อนไขจากประสบการณ์จริง
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Rating -->
                            <div class="bg-slate-50 p-4 md:p-6 border-t flex justify-center items-center gap-4 md:gap-6">
                                <span class="text-[11px] font-black text-slate-500 uppercase tracking-widest">ผลการวิเคราะห์มีประโยชน์ไหม?</span>
                                <div class="flex gap-4">
                                    <button onclick="app.setState({ feedback: 'up' })" class="w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center border transition-all ${this.state.feedback === 'up' ? 'bg-gradient-to-br from-emerald-500 to-green-500 text-white border-emerald-500' : 'bg-white text-slate-300 hover:text-emerald-500'}">
                                        ${ICONS.thumbsUp}
                                    </button>
                                    <button onclick="app.setState({ feedback: 'down' })" class="w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center border transition-all ${this.state.feedback === 'down' ? 'bg-gradient-to-br from-rose-500 to-pink-500 text-white border-rose-500' : 'bg-white text-slate-300 hover:text-rose-500'}">
                                        ${ICONS.thumbsDown}
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer Buttons -->
                        <div class="mt-6 md:mt-8 flex flex-wrap justify-center gap-3">
                            <button class="bg-white border text-slate-600 px-4 md:px-6 py-2 md:py-3 rounded-xl text-xs font-bold hover:bg-slate-50 flex items-center gap-2 shadow-sm">
                                ${ICONS.share} <span class="hidden md:inline">ส่งเข้า Line</span>
                            </button>
                            <button class="bg-white border text-slate-600 px-4 md:px-6 py-2 md:py-3 rounded-xl text-xs font-bold hover:bg-slate-50 flex items-center gap-2 shadow-sm">
                                ${ICONS.save} <span class="hidden md:inline">บันทึกเคส</span>
                            </button>
                            <button class="bg-white border text-slate-600 px-4 md:px-6 py-2 md:py-3 rounded-xl text-xs font-bold hover:bg-slate-50 flex items-center gap-2 shadow-sm">
                                ${ICONS.download} <span class="hidden md:inline">ดาวน์โหลด PDF</span>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            render() {
                const root = document.getElementById('root');
                if (!root) {
                    console.error("Root element not found!");
                    return;
                }
                
                try {
                    const html = this.state.isSetup ? this.renderMainPage() : this.renderSetupPage();
                    root.innerHTML = html;
                    
                    // Restore input values และเก็บ references
                    this.restoreInputValues();
                    
                    console.log("Render successful!");
                } catch (error) {
                    console.error("Render error:", error);
                    root.innerHTML = `
                        <div class="fixed-height flex items-center justify-center bg-red-50">
                            <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md">
                                <h1 class="text-2xl font-bold text-red-600 mb-4">เกิดข้อผิดพลาด</h1>
                                <p class="text-slate-600 mb-4">ระบบไม่สามารถแสดงผลได้ กรุณารีเฟรชหน้าเว็บ</p>
                                <button onclick="location.reload()" class="w-full bg-amber-600 text-white py-3 rounded-lg font-bold">
                                    รีเฟรชหน้าเว็บ
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
            
            restoreInputValues() {
                this.inputElements = {};
                
                for (const tab in this.state.forms) {
                    for (const field in this.state.forms[tab]) {
                        const id = `${tab}-${field}`;
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = this.state.forms[tab][field];
                            this.inputElements[id] = element;
                        }
                    }
                }
            }
            
            init() {
                // ตั้งค่า state เริ่มต้นจาก localStorage
                try {
                    const savedState = localStorage.getItem('mama_nonai_state');
                    if (savedState) {
                        const parsed = JSON.parse(savedState);
                        this.setState({ ...parsed });
                    }
                } catch (e) {
                    console.log("No saved state found");
                }
                
                // บันทึก state ลง localStorage เมื่อเปลี่ยนแปลง
                const originalSetState = this.setState.bind(this);
                this.setState = (newState) => {
                    originalSetState(newState);
                    try {
                        localStorage.setItem('mama_nonai_state', JSON.stringify({
                            ...this.state
                        }));
                    } catch (e) {
                        console.log("Could not save state to localStorage");
                    }
                };
                
                this.render();
            }
        }

        // เริ่มต้นแอปพลิเคชัน
        document.addEventListener('DOMContentLoaded', function() {
            window.app = new MAMAV2NonAI();
            console.log("MAMA V.2 Non-AI System loaded successfully!");
        });
    </script>
</body>
</html>
